<?xml version="1.0" encoding="UTF-8"?>

<project name="onPremInstall" default="seccess" >

    <!-- ============================================  -->
    <!-- Target: unzip installtion package             -->
    <!-- ============================================  -->
    <target name="unzipPackage">
         <echo msg="delete before unzip..." />
         <exec command="rm -rf Kaltura-TM-v4.0.0" dir="/web/content/kaltura_packages/drops/" />
         <exec command="rm -rf Kaltura-TM-v5.0.0" dir="/web/content/kaltura_packages/drops/" />

         <echo msg="unzip..." />
         <exec command="unzip /web/content/kaltura_packages/drops/TM-v5.0.0-beta.zip" dir="/web/content/kaltura_packages/drops/" />
    </target>


    <!-- ============================================  -->
    <!-- Target: set time zone in php.ini              -->
    <!-- ============================================  -->
    <target name="setTimeZone">
         <echo msg="setting time zone ..." />

         <copy file="/etc/php.ini" tofile="/etc/php.ini.1" overwrite="true">
              <filterchain>
                   <replaceregexp>
                        <regexp pattern=";date.timezone =$" replace="date.timezone = 'America/New_York'" ignoreCase="true"  modifiers="m" />
                   </replaceregexp>
              </filterchain>
         </copy>
         <copy file="/etc/php.ini.1" tofile="/etc/php.ini" overwrite="true">
              <filterchain>
                   <replaceregexp>
                        <regexp pattern="date.timezone =$" replace="date.timezone = 'America/New_York'" ignoreCase="true" modifiers="m"/>
                   </replaceregexp>
              </filterchain>
         </copy>

         <exec command="apachectl restart" dir="." />
    </target>

    <!-- ============================================  -->
    <!-- Target: init user_input file                  -->
    <!-- ============================================  -->
    <target name="initUserInputFile">
         <echo msg="init user_input file ..." />

         <copy file="/web/content/kaltura_packages/drops/Kaltura-TM-v5.0.0/user_input.bak" tofile="/web/content/kaltura_packages/drops/Kaltura-TM-v5.0.0/user_input.ini" overwrite="true">
              <filterchain>
                   <replacetokens begintoken="@@" endtoken="@@">
                        <token key="REPORT_MAIL" value="guyguy" />
                        <token key="HTTPD_BIN" value="/usr/sbin/apachectl" />
                        <token key="PHP_BIN" value="/usr/bin/php" />
                        <token key="BASE_DIR" value="/opt/kaltura" />
                        <token key="KALTURA_FULL_VIRTUAL_HOST_NAME" value="hudsontest1.kaltura.dev" />
                        <token key="ADMIN_CONSOLE_ADMIN_MAIL" value="admin@kaltura.com" />
                        <token key="ADMIN_CONSOLE_PASSWORD" value="admin" />
                        <token key="DB1_HOST" value="localhost" />
                        <token key="DB1_PORT" value="3306" />
                        <token key="DB1_NAME" value="kaltura" />
                        <token key="DB1_USER" value="root" />
                        <token key="DB1_PASS" value="" />
                        <token key="XYMON_URL" value="http://www.xymondomain.com/xymon/" />
                   </replacetokens>
              </filterchain>
         </copy>

    </target>


    <!-- ============================================  -->
    <!-- Target: Mysql upgrade                         -->
    <!-- ============================================  -->
    <target name="mysqlUpgrade">
         <echo msg="upgrading Mysql..." />
         <exec command="mysql_upgrade" dir="/web/content/kaltura_packages/drops" />
    </target>


    <!-- ============================================  -->
    <!-- Target: Installation                          -->
    <!-- ============================================  -->
    <target name="install" depends="setTimeZone,initUserInputFile,mysqlUpgrade">
         <echo msg="install..." />
         <exec command="php install.php -s;" dir="/web/content/kaltura_packages/drops/Kaltura-TM-v5.0.0" />
         <echo msg="Done" />
    </target>



    <!-- ============================================  -->
    <!-- Target: Success                               -->
    <!-- ============================================  -->
    <target name="seccess" depends="install">
         <echo msg="Done" />
    </target>



</project>